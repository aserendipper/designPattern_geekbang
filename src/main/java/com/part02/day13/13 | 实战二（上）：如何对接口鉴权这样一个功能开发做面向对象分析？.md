## 13 | 实战二（上）：如何对接口鉴权这样一个功能开发做面向对象分析？
需求：为了保证接口调用的安全性，希望设计实现一个接口调用鉴权功能，只有经过认证之后的系统才能调用接口，没有认证过的系统调用时拒绝访问。
### 一、第一轮基础分析
1、最简单的方案是，通过用户名和密码来做认证。   
2、给每一个允许访问的调用方，派发一个应用ID(AppID)和一个对应的密码(密钥)。  
3、调用方每次进行接口请求时，携带自己的AppID和密码。  
4、微服务在接收到接口调用请求之后，会解析出AppID和密码，跟存储在微服务端的AppID和密码进行比对。  
5、如果一致，说明认证成功，则允许接口调用请求，否则拒绝接口调用请求。

### 二、第二轮分析优化
问题：  
1、每次都需要明文传输密码，密码很容易被截取，是不安全的。  
2、如果借助加密算法，也是不安全的，未认证系统可以携带这个加密后的密码以及对应的AppID，伪装成已认证系统来访问接口，这就是典型的"重放攻击"。  
解决思路：  
1、可以借助OAuth验证思路来解决。  
2、调用方将请求接口的URL跟AppID、密码拼接在一起，然后加密生成一个token。  
3、调用方进行接口请求时，将这个token及AppID，随URL一块传递给微服务端。微服务端接收到这些数据之后，根据AppID获取数据库密码后并通过同样的token生成算法，生成另一个token。  
4、用这个新生成的token跟调用方传递过来的token对比。

### 三、第三轮分析优化
问题：  
1、每个URL拼接上AppID、密码生成的token是固定的。未认证系统截取URL、token和AppID之后，还是可以通过重放攻击的方式伪装成认证系统，调用这个URL对应的接口。  
解决思路：  
1、进一步优化token生成算法。  
2、引用随机变量时间戳，将URL、AppID、密码、时间戳进行加密来生成token。调用方在进行接口请求的时候，将token、AppID、时间戳随URL一并传递给微服务端。  
3、微服务端收到之后会验证当前时间戳跟传递过来的时间戳是否在一定的时间窗口内(比如一分钟)。如果超过一分钟，则判定token过期，拒绝接口请求。如果没有超过一分钟，则说明token
没有过期。  
4、再通过相同的token生成算法，在服务端生成新的token，与调用方传递的token比对。    
结论：  
1、未认证系统依然可以在这一分钟的token失效窗口内通过截取请求、重放请求来调用接口。  
2、攻与防之间，本来就没有绝对的安全。我们能做的就是尽量提高攻击的成本。

### 四、第四轮分析优化
问题：  
1、如何在微服务端存储每个授权调用方的AppID和密码。  
解决思路：  
1、最容易想到的是存储到数据库中，例如MYSQL。  
2、开发像鉴权这种的非业务功能，最好不要与具体的第三方系统有过度的耦合。  
3、针对AppID和密码的存储，最好能够灵活地支持各种不同的存储方式，比如Zookeeper、本地配置中心、自研配置中心、MySQL、Redis等。  
4、不一定针对每种存储方式做代码实现，但要留有扩展点，保证系统有足够的灵活性和扩展性，能够在我们切换存储方式的时候，尽可能地减少代码的改动。

### 五、最终确定需求
1、调用方进行接口请求的时候，将URL、AppID、密码、时间戳拼接在一起，通过加密算法生成token，并且将token、AppID、时间戳拼接在URL中，一并发送到微服务端。  
2、微服务端在接收到调用方的接口请求时，从请求中拆解出token、AppID、时间戳。  
3、微服务端首先检查传递过来的时间戳跟当前时间，是否在token失效时间窗口内。如果已经超过失效时间，那就算接口调用鉴权失败，拒绝接口调用请求。  
4、如果token验证没有过期失效，微服务端再从自己的存储中，取出AppID对应的密码，通过同样的token生成算法，生成另一个token，与调用方传递过来的token进行匹配。  
